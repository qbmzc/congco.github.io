---
title: MQ异步任务设计
date: 2021-08-09
categories:
  - work
tags:
  - MQ
---


![20210809133659](https://gitee.com/snowyan/image/raw/master/2021/20210809133659.jpg)

<!-- more -->

## 流程图

![20210826221212](https://gitee.com/snowyan/image/raw/master/2021/20210826221212.png)

1. Future自带的异步模式，依赖于当前的应用，队列任务位于内存中，服务一旦停止，未处理的任务即消失，适用场景有限。基于健壮性考虑，应使用消息队列执行异步任务。
2. 任务表的设计，应包含足够的信息，例如请求参数，如果较多，可使用`json`字符串`longtext`类型保存；包含业务相关请求参数，比如请求的来源，业务系统等；包含任务状态`tinyint`类型；包含异常信息，如果任务无法正常完成，那么原因是什么，最好包含具体的错误情况。
3. 消息发送，应该在任务保存之后进行，否则可能会出现任务查询不到，或者任务查询需要的相关信息无法获取到，比如文件保存的操作比较耗时。
4. `MQ`交换机类型选择`direct/topic`路由模式，广播模式会使路由失效，所有绑定该交换机的队列都会收到消息。
5. 重试次数限制，异常需要为`AMQE`或者其子类
6. 任务完成之后可以使用消息通知调用者，也可以提供接口，调用方轮询任务查询结果。

## MQ消息接收之后数据库查询失败的问题

处理异步任务时，任务先提交至数据库保存，然后发送MQ消息通知消费者进行任务的下一步处理。

但是在消费者处理任务时，查询数据库却发现此任务不存在。

排查之后发现，由于在提交任务时存在事务，尚未提交，即发送了消息，所以另外一个事务无法读取未提交的事务，因此查询不到此次任务。


## 解决方法

去除任务提交时的事务
