---
title: 十月记录
date: 2021-10-9
categories:
  - work
tags:
  - daily
keys:
 - 57f7e0a8a0b9055fa6cb7f3a03889387
---

<!-- more -->

## 存储类型

## 影响范围以及预估时间

### 数据库

- 添加字段,旧数据兼容

### 模块

- 新建存储模块
- *FileHandler 拆分处理逻辑与存储逻辑
- 文件下载兼容旧数据

### 测试

- 由于影响的较为基础，需要测试全面覆盖

### 预计时间

15个工作日

br

```shell
docker run -d -p 3306:3306 --name mariadb -v /data/mariadb/data/:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root mariadb:latest
```

## 文件后缀名

```bash
/getFile
  /download
  /downloadZip
  /
  
```

## jira任务

```shell
基于jira的日报规则：
issue类型目前只统计：任务, 故事（中文）, 测试用例, 缺陷, 子任务, Sub-task
issue状态只记录：Unresolved, 完成, 解决中
issue经办人是谁，代表了会将issue记入他（她）的名下
--------------------------------------------------------
时间段规则：
任务, 故事（中文） 这两种类型的issue的预计和延迟时间都会根据对应开始时间和结束时间计算
--------------------------------------------------------
时间点规则：
测试用例, 缺陷, 子任务, Sub-task 这四种类型的issue只有完成的时间，没有计划开始和计划结束时间
--------------------------------------------------------
各类型issue面向的用户角色不同：
故事（中文）     ->  功能模块的owner；
任务             ->  职能线组长和组员；
子任务, Sub-task ->  职能线组长和组员；
测试用例         ->  测试人员；        
缺陷             ->  测试人员；        
--------------------------------------------------------
FAQ：
Q：如果组长A把issue分配给了组员B（此时改issue状态为待办），但组员B没有接受，算计入组员B的代办吗？
A：不会，只有接收者接了issue（接受之后issue才会变成处理中/正在做），此时才计入组员B的issue，没有强买强卖。
---
Q：如果开发过程中，开发人员发现需要加一个任务，怎么办？
A：如果这个任务是指派给自己的，也不是新需求，建立一个子任务派给自己就行；如果这个任务是新需求，需要通过产品的沟通，确定为真实需求让产品建，并指派给职能线组长。
---
Q：如果工作过程中，插入了不可预计的内容，如临时开会，怎么办？
A：构建子任务为开会，分给自己就行，如果会议时间太长影响了任务的正常进行，可以调整任务的结束时间。
---
Q：测试用例和缺陷都归给测试人员，有啥区别吗？
A：测试用例是测试人员自建自销的issue，而缺陷是测试人员建了给开发人员解决的issue，虽然缺陷的解决方是开发，但是还是归在测试人员名下哦。
---
Q：继上一个问题，既然缺陷解决方是开发，如果开发迟迟不解决缺陷，不是会影响测试人员的issue完成度？
A：是的，问题客观存在但迟迟不修复，这种情况需要在缺陷的备注中添加“L1~L3：延迟原因”，让项目owner知悉，并制定解决方案，避免拖太久影响整体项目进度。
---
Q；啥时候变更jira的issue状态呢？
A：建议每天下班前整理当天的任务，把一天下来干的活对应的任务/子任务点成完成。把明天要干的活设置一下startTime=明天，养成良好习惯。
---
Q：超时很多天的任务如何处理？
A：可以看到，有些故事/任务延迟了十几天二十几天，这类issue如果实际上已经完成了，就应该close掉。如果依旧处于阻塞状态，在备注中添加“L1~L3：延迟原因”。
---
Q：备注中添加“L1~L3：延迟原因”的L1、L2、L3是什么意思？
A：L1:原型图交付延期一天等。一般应对3天以内的延期
   L2:缺陷设计导致功能交付打回，需要走中循环。一般应对3天~7天的延期
   L3:原始需求翻了，需要重新评估导致设计开发大循环。7天以上的延期
---
```

## RabbitMQ队列测试

受影响的消息队列

| 队列                            | 交换机                     | 路由                       |
| ------------------------------- | -------------------------- | -------------------------- |
| doc_convert_test                | fs_file_converter_exchange | safe_convert               |
| doc_convert_test_larger_file    | fs_file_converter_exchange | safe_larger_file_convert   |
| mq.document.process             | fs_file_converter_exchange | unsafe_convert             |
| mq.document.process.larger.file | fs_file_converter_exchange | unsafe_larger_file_convert |
|                                 |                            |                            |

## RabbitMQ消息丢失问题

9-23日，第三方服务报告pdf转换一直未完成，开始排查 登录转换服务器系统发现消息未接收到，fs系统日志显示消息已投递

涉及到的文件id如下

```bash
fileId=8a83802e7c0ca3f6017c108621bb00c6
fileId=8a8380307c0ca0b4017c108621cc00d8
fileId=8a8380307c0ca0b4017c1086224800db
```

MQ管理界面发现消费者下线了，之前有过一次UAT环境MQ无法连接的情况，fs服务无法重新连接，只能重启服务的情况。

![image-20211018103310893](https://gitee.com/snowyan/image/raw/master/2021/202110181033634.png)

联系运维恢复了mq的服务，消息被灾备环境消费掉，

问题，灾备环境应同步（复制）消息，而不是将消息消费掉，导致服务恢复后消息丢失，无法继续处理。

## 复现方案

启动一个转换任务，由于消费者掉线，生产者的消息投递成功，但是可能被灾备环境的队列的消费者消费掉，消费者服务恢复后，消息丢失的情况，这个可以记录下这种情况吗

## 问题

消费者掉线，没有自动重连

## fs任务优先级

- [ ] onlyoffice 前端对接
- [ ] pdf文件图片批注
- [ ] pdf文件预览签字模块感知回调
- [ ] 开启txt格式文件在线编辑

